!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("heartstring",[],t):"object"==typeof exports?exports.heartstring=t():e.heartstring=t()}(window,function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";var o=r(n(1)),i=r(n(10)),a=r(n(11));function r(e){return e&&e.__esModule?e:{default:e}}var u={GameState:i.default,Game:o.default,UI:a.default};document.addEventListener("DOMContentLoaded",function(e){!function(){var e=new u.GameState;e.Game=new u.Game(e),e.UI=new u.UI(e),e.UI.init()}()})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=s(n(2)),a=s(n(3)),r=s(n(4)),u=s(n(9));function s(e){return e&&e.__esModule?e:{default:e}}var l=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.GameState=t,this.audioContext=null,this.canvas=null,this.ctx=null,this.isMouseDown=!1,this.isPaused=!1,this.level=null,this.levelProgress=0,this.masterAudioNode=null,this.oldMousePos=0,this.rotation=0,this.sectionProgress=0,this.initCanvas(),this.initAudio(),this.initControls(),this.startRenderLoops()}return o(e,[{key:"play",value:function(){this.loadLevel()}},{key:"togglePause",value:function(){this.isPaused?this.audioContext.resume():this.audioContext.suspend(),this.isPaused=!this.isPaused}},{key:"getAudioRenderFrequency",value:function(){return null===this.level?500:(0,u.default)(this.level.bpm)}},{key:"loopValue",value:function(e,t,n){var o=n-t,i=(e-t)%o;return i<0&&(i+=o),t+i}},{key:"getNoteForPosition",value:function(e,t){var n=2*Math.PI/this.level.notes.length,o=2*Math.PI,i=this.loopValue(t+e,0,o),a=Math.abs(Math.floor(i/n));return this.level.notes[a]}},{key:"initCanvas",value:function(){var e=document.querySelector("canvas");e.width=window.innerWidth,e.height=window.innerHeight;var t=e.getContext("2d");this.cx=t.canvas.width/2,this.cy=t.canvas.height/2,this.canvas=e,this.ctx=t}},{key:"initAudio",value:function(){var e=new(window.AudioContext||window.webkitAudioContext);this.audioContext=e;var t=e.createGain();t.gain.value=.75,t.connect(e.destination),this.masterAudioNode=t}},{key:"initControls",value:function(){this.control=new i.default(this),this.control.init()}},{key:"startRenderLoops",value:function(){this.audioRender(),this.render()}},{key:"loadLevel",value:function(){var e=this,t=new r.default({audioContext:this.audioContext,masterAudioNode:this.masterAudioNode});t.load().then(function(){e.level=t,e.GameState.UI.updateBPM(e.level.bpm),e.GameState.UI.updateLevel(e.levelProgress)})}},{key:"drawNotes",value:function(){var e=this,t=2*Math.PI/this.level.notes.length;this.level.notes.forEach(function(n,o){var i=t*o,a=i+t;e.ctx.beginPath(),e.ctx.arc(e.cx,e.cy,e.cx/2,i-e.rotation,a-e.rotation),e.ctx.lineWidth=15,e.ctx.strokeStyle=n.color,e.ctx.stroke()})}},{key:"drawNoteTriggers",value:function(){var e=this;this.level.noteTriggers.forEach(function(t){if(t.nextNote){var n=e.cx/2,o=e.cx+n*Math.cos(t.position),i=e.cy+n*Math.sin(t.position),r=t.endTime-t.startTime,u=(t.endTime-Date.now())/r,s=(0,a.default)(o,e.cx,u),l=(0,a.default)(i,e.cy,u);e.ctx.beginPath(),e.ctx.fillStyle=t.nextNote.color,e.ctx.arc(s,l,10,0,2*Math.PI),e.ctx.fill()}})}},{key:"render",value:function(){window.requestAnimationFrame(this.render.bind(this)),this.isPaused||null===this.level||(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawNotes(),this.drawNoteTriggers())}},{key:"audioRender",value:function(){var e=this,t=this.getAudioRenderFrequency();if(setTimeout(this.audioRender.bind(this),t),!this.isPaused&&null!==this.level){var n=this.level.sections[this.levelProgress];n&&(n.beatCounter++,n.beatCounter>n.beats&&(n.beatCounter=1,this.level.sections[this.levelProgress].buffer.play(t)),this.level.noteTriggers.forEach(function(t){t.beatCounter++,t.beatCounter>t.beats&&(t.beatCounter=1,t.note=e.getNoteForPosition(t.position,e.rotation),null!==t.nextNote&&t.note!==t.nextNote&&(e.sectionProgress=0,e.level.noteTriggers.forEach(function(e){e.nextNote=null}),e.GameState.score-=8),null!==t.nextNote&&t.note===t.nextNote&&(e.GameState.score+=10),t.nextNote&&t.fire(),t.nextNote=e.level.notes[e.level.sections[e.levelProgress].unlockPattern[e.sectionProgress]],e.sectionProgress>e.level.sections[e.levelProgress].unlockPattern.length&&(e.levelProgress++,e.sectionProgress=0),e.levelProgress>=e.level.sections.length&&(e.GameState.UI.setScreen("score"),setTimeout(function(){return e.isPaused=!0},250)),e.sectionProgress++,t.startTime=Date.now(),t.endTime=Date.now()+(0,u.default)(e.level.bpm)*t.beats,e.GameState.UI.updateScore(e.GameState.score))}))}}}]),e}();t.default=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();var i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.Game=t}return o(e,[{key:"init",value:function(){var e=this;document.body.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.body.addEventListener("mousedown",function(t){e.Game.isMouseDown=!0,e.Game.oldMousePos=t.clientX}),document.body.addEventListener("mouseup",function(t){e.Game.isMouseDown=!1}),document.onkeydown=this.handleKeypress.bind(this)}},{key:"handleMouseMove",value:function(e){this.Game.isMouseDown&&!this.Game.isPaused&&(this.Game.rotation+=.01*(this.Game.oldMousePos-e.clientX),this.Game.oldMousePos=e.clientX)}},{key:"handleKeypress",value:function(e){if(e=e||window.event,!this.Game.isPaused&&null!==this.Game.level){var t=2*Math.PI/this.Game.level.notes.length;e.keyCode,e.keyCode,"37"==e.keyCode&&(this.Game.rotation+=t),"39"==e.keyCode&&(this.Game.rotation-=t)}}}]),e}();t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){return e*(1-n)+t*n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=s(n(5)),a=s(n(6)),r=s(n(7)),u=s(n(8));function s(e){return e&&e.__esModule?e:{default:e}}var l=function(){function e(t){var n=t.audioContext,o=t.bpm,i=void 0===o?100:o,s=t.sections,l=void 0===s?[new u.default({unlockPattern:[0,1,2,3,4,5]}),new u.default({unlockPattern:[5,4,3,2,1,0]})]:s,c=t.GameState,d=t.masterAudioNode,f=t.notes,h=void 0===f?[new a.default({audioContext:n,bpm:i,color:"red",frequency:88}),new a.default({audioContext:n,bpm:i,color:"orange",frequency:98.776}),new a.default({audioContext:n,bpm:i,color:"yellow",frequency:104.65}),new a.default({audioContext:n,bpm:i,color:"green",frequency:117.466}),new a.default({audioContext:n,bpm:i,color:"blue",frequency:131.85}),new a.default({audioContext:n,bpm:i,color:"indigo",frequency:139.692})]:f,v=t.noteTriggers,y=void 0===v?[new r.default({masterAudioNode:d,noteDuration:100,startDelay:0,position:-Math.PI/4,beats:4}),new r.default({masterAudioNode:d,noteDuration:100,startDelay:1,position:Math.PI/4,beats:4})]:v;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.audioContext=n,this.sections=l,this.bpm=i,this.GameState=c,this.masterAudioNode=d,this.notes=h,this.noteTriggers=y}return o(e,[{key:"load",value:function(){var e=this;return new Promise(function(t,n){e.sections.forEach(function(n){n.buffer=new i.default({audioContext:e.audioContext,audioFileUrl:n.url,masterAudioNode:e.masterAudioNode}),new Promise(n.buffer.load.bind(n.buffer)).then(function(){n.isLoaded=!0,t()})}),t()})}}]),e}();t.default=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();var i=function(){function e(t){var n=t.audioFileUrl,o=t.audioContext,i=t.masterAudioNode,a=t.shouldLoop,r=void 0!==a&&a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.audioContext=o,this.audioFileUrl=window.location.href+"audio/"+n,this.audioNode=null,this.buffer=null,this.masterAudioNode=i,this.shouldLoop=r}return o(e,[{key:"load",value:function(e,t){var n=this,o=new XMLHttpRequest;o.responseType="arraybuffer",o.onload=function(){n.createBufferFromData(o.response,e)},o.onerror=function(){console.log("Failed to load audio file"),t()},o.open("GET",this.audioFileUrl,!0),o.send()}},{key:"createBufferFromData",value:function(e,t){var n=this;this.audioContext.decodeAudioData(e,function(e){n.buffer=e,t()})}},{key:"play",value:function(e){this.audioNode=this.audioContext.createBufferSource(),this.audioNode.buffer=this.buffer,this.audioNode.playbackRate.value=1,this.audioNode.loop=this.shouldLoop,this.audioNode.connect(this.masterAudioNode),this.audioNode.start(0),e&&this.audioNode.stop(e)}},{key:"stop",value:function(){this.audioNode.stop()}}]),e}();t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();var i=function(){function e(t){var n=t.audioContext,o=t.color,i=void 0===o?"rgba(255, 255, 255, 1)":o,a=t.frequency,r=void 0===a?110:a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.audioContext=n,this.color=i,this.frequency=r,this.audioNode=this.initAudioNode(n)}return o(e,[{key:"initAudioNode",value:function(e){var t=e.createOscillator();t.type="square",t.frequency.setValueAtTime(this.frequency,e.currentTime),t.start();var n=e.createGain();return n.gain.value=.05,t.connect(n)}}]),e}();t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();var i=function(){function e(t){var n=t.masterAudioNode,o=t.noteDuration,i=void 0===o?100:o,a=t.position,r=void 0===a?0:a,u=t.startDelay,s=void 0===u?0:u,l=t.beats,c=void 0===l?1:l;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.masterAudioNode=n,this.note=null,this.noteDuration=i,this.startDelay=s,this.beats=c,this.beatCounter=c-s,this.nextNote=null,this.startTime=null,this.position=r}return o(e,[{key:"fire",value:function(){var e=this;if(null!==this.note){var t=Object.assign({},this.note);this.playNote(t),setTimeout(function(){e.stopNote(t)},this.noteDuration)}}},{key:"playNote",value:function(e){e.audioNode.connect(this.masterAudioNode)}},{key:"stopNote",value:function(e){e.audioNode.disconnect(this.masterAudioNode)}}]),e}();t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=function e(t){var n=t.beats,o=void 0===n?4:n,i=t.buffer,a=void 0===i?null:i,r=t.isLoaded,u=void 0!==r&&r,s=t.unlockPattern,l=void 0===s?[0,1,2,3,4,5]:s,c=t.url,d=void 0===c?"metronome-100-bpm.ogg":c;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.beats=o,this.buffer=a,this.isLoaded=u,this.unlockPattern=l,this.url=d,this.beatCounter=4}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return 6e4/e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.difficulty=1,this.level=null,this.playerName="neek",this.score=0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();var i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.GameState=t,this.screens=document.querySelectorAll(".Screen"),this.buttons={mute:document.querySelectorAll('[data-nav="mute"]'),quit:document.querySelectorAll('[data-nav="quit"]'),transitions:document.querySelectorAll("[data-target-screen]"),play:document.querySelectorAll("[data-gamestate-play]"),pause:document.querySelectorAll("[data-gamestate-pause]")}}return o(e,[{key:"init",value:function(){this.initListenters(),this.setScreen("mainmenu"),this.updateScore(),this.updatePlayerName(),this.updateLevel()}},{key:"initListenters",value:function(){var e=this;Array.from(this.buttons.play).forEach(function(t){t.addEventListener("click",function(){return e.GameState.Game.play()})}),Array.from(this.buttons.pause).forEach(function(t){t.addEventListener("click",function(){return e.GameState.Game.togglePause()})}),Array.from(this.buttons.quit).forEach(function(e){e.addEventListener("click",function(){return window.close()})}),Array.from(this.buttons.mute).forEach(function(t){t.addEventListener("click",function(t){var n=e.GameState.Game.audioContext;"running"===n.state?n.suspend().then(function(){t.target.innerHTML="Resume"}):"suspended"===n.state&&n.resume().then(function(){t.target.innerHTML="Mute"})})}),Array.from(this.buttons.transitions).forEach(function(t){t.addEventListener("click",e.initTransitions.bind(e))})}},{key:"initTransitions",value:function(e){this.setScreen(e.target.dataset.targetScreen)}},{key:"setScreen",value:function(e){Array.from(this.screens).forEach(function(t){t.dataset.screen===e?t.classList.add("active"):t.classList.remove("active")})}},{key:"updateScore",value:function(e){document.querySelector('[data-ui="score"]').innerHTML=e}},{key:"updatePlayerName",value:function(){document.querySelector('[data-ui="playerName"]').innerHTML=this.GameState.playerName}},{key:"updateLevel",value:function(e){document.querySelector('[data-ui="level"]').innerHTML=e}},{key:"updateBPM",value:function(e){document.querySelector('[data-ui="bpm"]').innerHTML=e}}]),e}();t.default=i}])});